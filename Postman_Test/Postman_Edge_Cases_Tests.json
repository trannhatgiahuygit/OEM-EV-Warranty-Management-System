{
  "info": {
    "name": "Edge Cases and Error Handling Tests",
    "description": "Test các trường hợp đặc biệt và xử lý lỗi",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. Login SC Staff",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"SC Staff login successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    var token = jsonData.token || jsonData.accessToken;",
              "    pm.collectionVariables.set(\"sc_staff_token\", token);",
              "    pm.collectionVariables.set(\"sc_staff_id\", jsonData.userId || jsonData.id);",
              "    console.log(\"✅ SC Staff Token saved\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"sc_staff1\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "2. Test Invalid VIN",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Invalid VIN should return error\", function () {",
              "    pm.response.to.have.status(404);",
              "});",
              "",
              "pm.test(\"Error message present\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.message || jsonData.error).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicles/vin/INVALID_VIN_123",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicles", "vin", "INVALID_VIN_123"]
        }
      }
    },
    {
      "name": "3. Test Out of Warranty Vehicle",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Out of warranty vehicle should be detected\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Warranty status should be false\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.isInWarranty).to.be.false;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicles/vin/EXPIRED001/warranty-status",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicles", "vin", "EXPIRED001", "warranty-status"]
        }
      }
    },
    {
      "name": "4. Create Claim for Out of Warranty Vehicle",
      "event": [
        {
          "listen": "test",
          "script": [
            {
              "exec": [
                "pm.test(\"Out of warranty claim should be created\", function () {",
                "    pm.response.to.have.status(201);",
                "});",
                "",
                "if (pm.response.code === 201) {",
                "    var jsonData = pm.response.json();",
                "    pm.collectionVariables.set(\"out_of_warranty_claim_id\", jsonData.id);",
                "    console.log(\"✅ Out of Warranty Claim ID: \" + jsonData.id);",
                "}"
              ],
              "type": "text/javascript"
            }
          ]
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"vin\": \"EXPIRED001\",\n  \"customerName\": \"Test Customer\",\n  \"customerEmail\": \"test@example.com\",\n  \"customerPhone\": \"0901234567\",\n  \"customerAddress\": \"123 Test Street\",\n  \"reportedFailure\": \"Battery replacement needed - out of warranty\",\n  \"initialDiagnosis\": \"Battery pack failure - customer responsible for cost\",\n  \"mileageKm\": 85000,\n  \"flow\": \"draft\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/intake",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "intake"]
        }
      }
    },
    {
      "name": "5. Login EVM Staff",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"EVM Staff login successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    var token = jsonData.token || jsonData.accessToken;",
              "    pm.collectionVariables.set(\"evm_token\", token);",
              "    pm.collectionVariables.set(\"evm_id\", jsonData.userId || jsonData.id);",
              "    console.log(\"✅ EVM Staff Token saved\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"evm_staff1\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "6. Reject Out of Warranty Claim",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Reject out of warranty claim successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status should be EVM_REJECTED\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.include(\"EVM_REJECTED\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{evm_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"rejectionReason\": \"OUT_OF_WARRANTY\",\n  \"rejectionNotes\": \"Vehicle warranty expired on 2023-01-01. Customer responsible for repair costs.\",\n  \"suggestedAction\": \"SUGGEST_CUSTOMER_PAY\",\n  \"requiresAdditionalInfo\": false,\n  \"notifyCustomer\": true\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/evm/claims/{{out_of_warranty_claim_id}}/reject",
          "host": ["{{base_url}}"],
          "path": ["api", "evm", "claims", "{{out_of_warranty_claim_id}}", "reject"]
        }
      }
    },
    {
      "name": "7. Test Insufficient Stock",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Insufficient stock should return error\", function () {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test(\"Error message about insufficient stock\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.message || jsonData.error).to.include(\"Insufficient\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"workOrderId\": 999,\n  \"items\": [\n    {\n      \"partId\": 1,\n      \"quantity\": 1000\n    }\n  ]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/inventory/reserve",
          "host": ["{{base_url}}"],
          "path": ["api", "inventory", "reserve"]
        }
      }
    },
    {
      "name": "8. Test Duplicate Claim Number",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Duplicate claim should be handled gracefully\", function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "pm.test(\"Claim number should be unique\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.claimNumber).to.exist;",
              "    pm.expect(jsonData.claimNumber).to.not.eql(\"CLM-2024-001\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"vin\": \"1HGBH41JXMN109186\",\n  \"customerName\": \"Michael Thompson\",\n  \"customerEmail\": \"michael.t@email.com\",\n  \"customerPhone\": \"0987654321\",\n  \"customerAddress\": \"123 Main St, New York, NY 10001\",\n  \"reportedFailure\": \"Another issue with the same vehicle\",\n  \"initialDiagnosis\": \"Additional diagnostic required\",\n  \"mileageKm\": 25000,\n  \"flow\": \"draft\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/intake",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "intake"]
        }
      }
    },
    {
      "name": "9. Test Invalid Technician Assignment",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Invalid technician should return error\", function () {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test(\"Error message about invalid technician\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.message || jsonData.error).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": 1,\n  \"technicianId\": 999,\n  \"estimatedLaborHours\": 2.0,\n  \"startTime\": \"2024-01-20T08:00:00\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/work-orders/create",
          "host": ["{{base_url}}"],
          "path": ["api", "work-orders", "create"]
        }
      }
    },
    {
      "name": "10. Test Unauthorized Access",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Unauthorized access should return 403\", function () {",
              "    pm.response.to.have.status(403);",
              "});",
              "",
              "pm.test(\"Error message about unauthorized access\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.message || jsonData.error).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/evm/claims/pending",
          "host": ["{{base_url}}"],
          "path": ["api", "evm", "claims", "pending"]
        }
      }
    },
    {
      "name": "11. Test Invalid Token",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Invalid token should return 401\", function () {",
              "    pm.response.to.have.status(401);",
              "});",
              "",
              "pm.test(\"Error message about invalid token\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.message || jsonData.error).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer invalid_token_123"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/claims",
          "host": ["{{base_url}}"],
          "path": ["api", "claims"]
        }
      }
    },
    {
      "name": "12. Test Malformed JSON",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Malformed JSON should return 400\", function () {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test(\"Error message about malformed JSON\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.message || jsonData.error).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"vin\": \"1HGBH41JXMN109186\",\n  \"customerName\": \"Test Customer\",\n  \"customerEmail\": \"test@example.com\",\n  \"customerPhone\": \"0901234567\",\n  \"customerAddress\": \"123 Test Street\",\n  \"reportedFailure\": \"Test failure\",\n  \"initialDiagnosis\": \"Test diagnosis\",\n  \"mileageKm\": 25000,\n  \"flow\": \"draft\"\n  // Missing closing brace"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/intake",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "intake"]
        }
      }
    },
    {
      "name": "13. Test Large File Upload",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Large file upload should be handled\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"File upload response present\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.message || jsonData.success).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "formdata",
          "formdata": [
            {
              "key": "file",
              "type": "file",
              "src": "large_test_file.txt"
            },
            {
              "key": "claimId",
              "value": "1",
              "type": "text"
            },
            {
              "key": "fileType",
              "value": "diagnostic_report",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{base_url}}/api/claims/1/attachments",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "1", "attachments"]
        }
      }
    },
    {
      "name": "14. Test Concurrent Claims",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Concurrent claims should be handled\", function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "pm.test(\"Claim created successfully\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.id).to.exist;",
              "    pm.expect(jsonData.claimNumber).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"vin\": \"1HGBH41JXMN109187\",\n  \"customerName\": \"Concurrent Test Customer\",\n  \"customerEmail\": \"concurrent@example.com\",\n  \"customerPhone\": \"0901234567\",\n  \"customerAddress\": \"123 Concurrent Street\",\n  \"reportedFailure\": \"Concurrent test failure\",\n  \"initialDiagnosis\": \"Concurrent test diagnosis\",\n  \"mileageKm\": 18000,\n  \"flow\": \"draft\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/intake",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "intake"]
        }
      }
    },
    {
      "name": "15. Test System Performance",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Response time should be acceptable\", function () {",
              "    pm.expect(pm.response.responseTime).to.be.below(5000);",
              "});",
              "",
              "pm.test(\"System performance test passed\", function () {",
              "    pm.response.to.have.status(200);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/claims?page=0&size=100",
          "host": ["{{base_url}}"],
          "path": ["api", "claims"],
          "query": [
            {
              "key": "page",
              "value": "0"
            },
            {
              "key": "size",
              "value": "100"
            }
          ]
        }
      }
    }
  ]
}
