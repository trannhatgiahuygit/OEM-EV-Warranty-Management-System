{
  "info": {
    "name": "Warranty Claim Flow Tests",
    "description": "Test toàn bộ quy trình bảo hành từ tạo claim đến hoàn tất",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "base_url", "value": "http://localhost:8080", "type": "string" },
    { "key": "vin", "value": "1HGBH41JXMN109186", "type": "string" },
    { "key": "old_serial", "value": "BAT001-2023-001", "type": "string" },
    { "key": "new_serial", "value": "BAT001-2023-003", "type": "string" },
    { "key": "part_id", "value": "1", "type": "string" },
    { "key": "test_problem_scenario", "value": "true", "type": "string" }
  ],
  "item": [
    {
      "name": "1. Login SC Staff",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"SC Staff login successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    pm.collectionVariables.set(\"sc_staff_username\", jsonData.username);",
              "    var token = jsonData.token || jsonData.accessToken;",
              "    pm.collectionVariables.set(\"sc_staff_token\", token);",
              "    pm.collectionVariables.set(\"sc_staff_id\", jsonData.userId || jsonData.id);",
              "    console.log(\"✅ SC Staff Token saved\");",
              "}",
              ""
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"sc_staff1\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "2. Login Technician",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Technician login successful\", function () { pm.response.to.have.status(200); });",
              "const json = pm.response.json();",
              "pm.collectionVariables.set('tech_token', json.token || json.accessToken);",
              "pm.collectionVariables.set('tech_username', json.username);",
              "pm.collectionVariables.set('tech_user_id', json.userId || json.id);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"tech2\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "3. Login EVM Staff",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"EVM Staff login successful\", function () { pm.response.to.have.status(200); });",
              "const json = pm.response.json();",
              "pm.collectionVariables.set('evm_token', json.token || json.accessToken);",
              "pm.collectionVariables.set('evm_username', json.username);",
              "pm.collectionVariables.set('evm_user_id', json.userId || json.id);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"username\": \"evm_staff1\",\n  \"password\": \"123\"\n}" },
        "url": { "raw": "{{base_url}}/api/auth/login", "host": ["{{base_url}}"], "path": ["api","auth","login"] }
      }
    },
    {
      "name": "3.1. Danh sách KTV rảnh (SC_STAFF)",
      "request": {
        "method": "GET",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" } ],
        "url": { "raw": "{{base_url}}/api/technicians/available", "host": ["{{base_url}}"], "path": ["api","technicians","available"] }
      },
      "event": [
        { "listen": "test", "script": { "exec": [
          "pm.test('Available technicians retrieved', () => pm.response.to.have.status(200));",
          "try { const list = pm.response.json(); if (Array.isArray(list) && list.length>0) { const t = list[0]; if (!pm.collectionVariables.get('tech_user_id')) { pm.collectionVariables.set('tech_user_id', t.userId || t.id); } } } catch(e){};",
          "pm.test('Technician selected (fallback OK)', () => pm.expect(pm.collectionVariables.get('tech_user_id')).to.exist);"
        ], "type": "text/javascript" } }
      ]
    },
    {
      "name": "4. Tra cứu xe theo VIN (SC_STAFF)",
      "request": {
        "method": "GET",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" } ],
        "url": { "raw": "{{base_url}}/api/vehicles/vin/{{vin}}", "host": ["{{base_url}}"], "path": ["api","vehicles","vin","{{vin}}"] }
      },
      "event": [
        { "listen": "test", "script": { "exec": [
          "pm.test('Vehicle found', () => pm.response.to.have.status(200));",
          "const v = pm.response.json();",
          "pm.collectionVariables.set('vehicle_id', v.id || v.vehicleId);",
          "pm.collectionVariables.set('vehicle_model', v.model);",
          "pm.test('Vehicle ID captured', () => pm.expect(pm.collectionVariables.get('vehicle_id')).to.exist);"
        ], "type": "text/javascript" } }
      ]
    },
    {
      "name": "5. Kiểm tra bảo hành (SC_STAFF)",
      "request": {
        "method": "GET",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" } ],
        "url": { "raw": "{{base_url}}/api/vehicles/{{vehicle_id}}/warranty-status", "host": ["{{base_url}}"], "path": ["api","vehicles","{{vehicle_id}}","warranty-status"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('Warranty status OK', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },
    {
      "name": "5.1. Validate Warranty Policy (SC_STAFF)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"vin\": \"{{vin}}\",\n  \"componentCategory\": \"Battery\",\n  \"currentMileageKm\": 25500,\n  \"failureDate\": \"{{today_date}}\",\n  \"failureDescription\": \"Customer reported B001 error\",\n  \"serialNumber\": \"{{old_serial}}\"\n}"
        },
        "url": { "raw": "{{base_url}}/api/warranty-policies/validate", "host": ["{{base_url}}"], "path": ["api","warranty-policies","validate"] }
      },
      "event": [
        { "listen": "prerequest", "script": { "type": "text/javascript", "exec": [ "pm.collectionVariables.set('today_date', new Date().toISOString().slice(0,10));" ] } },
        { "listen": "test", "script": { "type": "text/javascript", "exec": [
          "pm.test('Warranty validation 200', () => pm.response.to.have.status(200));",
          "const res = pm.response.json(); pm.collectionVariables.set('warranty_isCovered', res.isCovered); pm.collectionVariables.set('coverageType', res.coverageType||'');"
        ] } }
      ]
    },
    {
      "name": "5.2. Chính sách theo model (SC_STAFF)",
      "request": { "method": "GET", "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" } ], "url": { "raw": "{{base_url}}/api/warranty-policies/model/{{vehicle_model}}", "host": ["{{base_url}}"], "path": ["api","warranty-policies","model","{{vehicle_model}}"] } },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('Policies by model 200', () => pm.response.to.have.status(200));" ] } } ]
    },
    {
      "name": "5.3. EVM tạo Service Item (S-*)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{evm_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"serviceCode\": \"{{service_code}}\",\n  \"name\": \"Battery Replacement Labor\",\n  \"description\": \"Labor to replace battery pack\",\n  \"standardLaborHours\": 8,\n  \"category\": \"Battery\",\n  \"active\": true\n}" },
        "url": { "raw": "{{base_url}}/api/service-catalog/services", "host": ["{{base_url}}"], "path": ["api","service-catalog","services"] }
      },
      "event": [
        { "listen": "prerequest", "script": { "type": "text/javascript", "exec": [ "pm.collectionVariables.set('service_code', 'S-REPL-' + Date.now()); pm.collectionVariables.set('today_date', new Date().toISOString().slice(0,10)); pm.collectionVariables.set('price_region', 'HN-' + Date.now());" ] } },
        { "listen": "test", "script": { "type": "text/javascript", "exec": [
          "pm.test('Service item created or exists', () => pm.expect([200,201]).to.include(pm.response.code));",
          "// Try to capture the created service item ID",
          "(function(){",
          "  try {",
          "    const body = pm.response.json();",
          "    const id = body.id || body.serviceItemId || (body.data && (body.data.id || body.data.serviceItemId));",
          "    if (id) { pm.collectionVariables.set('service_item_id', id); }",
          "  } catch(e) {}",
          "})();",
          "// Fallback: lookup by service code if ID wasn't in create response",
          "if (!pm.collectionVariables.get('service_item_id')) {",
          "  pm.sendRequest({",
          "    url: pm.collectionVariables.get('base_url') + '/api/service-catalog/services/code/' + encodeURIComponent(pm.collectionVariables.get('service_code')),",
          "    method: 'GET',",
          "    header: [ { key: 'Authorization', value: 'Bearer ' + pm.collectionVariables.get('evm_token') } ]",
          "  }, function (err, res) {",
          "    if (!err && res && res.code === 200) {",
          "      try { const js = res.json(); const sid = js && (js.id || js.serviceItemId); if (sid) { pm.collectionVariables.set('service_item_id', sid); } } catch(e) {}",
          "    }",
          "  });",
          "}",
          "pm.test('service_item_id resolved', function () { pm.expect(pm.collectionVariables.get('service_item_id')).to.exist; });"
        ] } }
      ]
    },
    {
      "name": "5.4. EVM đặt giá SERVICE",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{evm_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"itemType\": \"SERVICE\",\n  \"itemId\": {{service_item_id}},\n  \"price\": 1500000,\n  \"currency\": \"VND\",\n  \"region\": \"{{price_region}}\",\n  \"serviceCenterId\": null,\n  \"effectiveFrom\": \"{{today_date}}\"\n}" },
        "url": { "raw": "{{base_url}}/api/service-catalog/prices", "host": ["{{base_url}}"], "path": ["api","service-catalog","prices"] }
      },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('Service price created', () => pm.expect([200,201]).to.include(pm.response.code));" ] } } ]
    },
    {
      "name": "5.5. EVM đặt giá PART (Battery)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{evm_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"itemType\": \"PART\",\n  \"itemId\": {{part_id}},\n  \"price\": 95000000,\n  \"currency\": \"VND\",\n  \"region\": \"{{price_region}}\",\n  \"serviceCenterId\": null,\n  \"effectiveFrom\": \"{{today_date}}\"\n}" },
        "url": { "raw": "{{base_url}}/api/service-catalog/prices", "host": ["{{base_url}}"], "path": ["api","service-catalog","prices"] }
      },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('Part price created', () => pm.expect([200,201]).to.include(pm.response.code));" ] } } ]
    },
    {
      "name": "5.6. Tra cứu Service Items (SC/KTV)",
      "request": { "method": "GET", "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" } ], "url": { "raw": "{{base_url}}/api/service-catalog/services?search=Battery&active=true", "host": ["{{base_url}}"], "path": ["api","service-catalog","services"], "query": [ {"key":"search","value":"Battery"},{"key":"active","value":"true"} ] } },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('Service items fetched', () => pm.response.to.have.status(200));" ] } } ]
    },
    {
      "name": "5.7. Giá hiện hành PART",
      "request": { "method": "GET", "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" } ], "url": { "raw": "{{base_url}}/api/service-catalog/prices/current/PART/{{part_id}}?region={{price_region}}", "host": ["{{base_url}}"], "path": ["api","service-catalog","prices","current","PART","{{part_id}}"], "query": [ {"key":"region","value":"{{price_region}}"} ] } },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('Current PART price 200', () => pm.response.to.have.status(200));" ] } } ]
    },
    {
      "name": "5.8. Giá hiện hành SERVICE",
      "request": { "method": "GET", "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" } ], "url": { "raw": "{{base_url}}/api/service-catalog/prices/current/SERVICE/{{service_item_id}}?region={{price_region}}", "host": ["{{base_url}}"], "path": ["api","service-catalog","prices","current","SERVICE","{{service_item_id}}"], "query": [ {"key":"region","value":"{{price_region}}"} ] } },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('Current SERVICE price 200', () => pm.response.to.have.status(200));" ] } } ]
    },
    {
      "name": "5.9. Tính estimate (SC/KTV)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"partItems\": [ { \"itemId\": {{part_id}}, \"quantity\": 1 } ],\n  \"serviceItems\": [ { \"itemId\": {{service_item_id}}, \"quantity\": 1 } ],\n  \"region\": \"{{price_region}}\",\n  \"currency\": \"VND\"\n}" },
        "url": { "raw": "{{base_url}}/api/service-catalog/calculate-estimate", "host": ["{{base_url}}"], "path": ["api","service-catalog","calculate-estimate"] }
      },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('Estimate calculated', () => pm.response.to.have.status(200));" ] } } ]
    },
    {
      "name": "6. Lấy cấu hình linh kiện xe (KTV)",
      "request": {
        "method": "GET",
        "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" } ],
        "url": { "raw": "{{base_url}}/api/part-serials/vehicle/{{vin}}", "host": ["{{base_url}}"], "path": ["api","part-serials","vehicle","{{vin}}"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [
        "pm.test('Vehicle parts retrieved', () => pm.response.to.have.status(200));",
        "const res = pm.response.json(); try { const list = res.parts || res.installedParts || []; const bat = list.find(p => ((p.category||'')+ (p.partName||'')).toLowerCase().includes('battery')); if (bat) { if (bat.serialNumber) pm.collectionVariables.set('old_serial', bat.serialNumber); if (bat.partId) pm.collectionVariables.set('old_part_id', bat.partId); if (bat.partSerialId) pm.collectionVariables.set('old_serial_id', bat.partSerialId);} } catch(e){};",
        "pm.test('Old serial ready', () => pm.expect(pm.collectionVariables.get('old_serial')).to.be.a('string'));"
      ], "type": "text/javascript" } } ]
    },
    {
      "name": "7. Tạo Claim DRAFT (SC_STAFF)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"customerName\": \"Michael Thompson\",\n  \"customerPhone\": \"0987654321\",\n  \"customerEmail\": \"michael.t@email.com\",\n  \"customerAddress\": \"123 Main St, New York, NY 10001\",\n  \"vin\": \"{{vin}}\",\n  \"mileageKm\": 25500,\n  \"claimTitle\": \"Battery not charging properly\",\n  \"reportedFailure\": \"Khách báo pin không sạc, báo lỗi B001\",\n  \"assignedTechnicianId\": {{tech_user_id}},\n  \"flow\": \"DRAFT\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/draft", "host": ["{{base_url}}"], "path": ["api","claims","draft"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [
        "pm.test('Claim DRAFT created', () => pm.response.to.have.status(201));",
        "const c = pm.response.json(); pm.collectionVariables.set('claim_id', c.id); pm.collectionVariables.set('claim_number', c.claimNumber);",
        "pm.test('Status DRAFT', () => pm.expect((c.status||'').toUpperCase()).to.eql('DRAFT'));"
      ], "type": "text/javascript" } } ]
    },
    {
      "name": "8. Chuyển claim -> IN_PROGRESS (SC_STAFF)",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{ \n  \"status\": \"IN_PROGRESS\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/status", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","status"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [
        "pm.test('Status IN_PROGRESS', () => { pm.response.to.have.status(200); pm.expect((pm.response.json().status||'').toUpperCase()).to.eql('IN_PROGRESS'); });"
      ], "type": "text/javascript" } } ]
    },
    {
      "name": "9. KTV cập nhật chẩn đoán (SC_TECHNICIAN)",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"claimId\": {{claim_id}},\n  \"diagnosticSummary\": \"BMS lỗi, pin không nhận sạc\",\n  \"diagnosticData\": \"{\\\"code\\\":\\\"B001\\\",\\\"voltage\\\":\\\"298V\\\"}\",\n  \"testResults\": \"OCV thấp, cell imbalance 40mV\",\n  \"repairNotes\": \"Đề xuất thay pack pin\",\n  \"laborHours\": 2.5,\n  \"partsUsed\": [{ \"partId\": 1, \"partSerialId\": null, \"quantity\": 1, \"notes\": \"Battery pack replacement planned\" }],\n  \"attachmentPaths\": [\"/uploads/diagnostic/photo1.jpg\"],\n  \"initialDiagnosis\": \"Suspect battery pack failure\",\n  \"readyForSubmission\": true\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/diagnostic", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","diagnostic"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('Diagnostic updated', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },
    {
      "name": "9.5. Set status -> PENDING_APPROVAL (SC_TECHNICIAN)",
      "request": {
        "method": "PUT",
        "header": [
          { "key": "Authorization", "value": "Bearer {{tech_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"status\": \"PENDING_APPROVAL\", \"statusNote\": \"Technician requests EVM approval via status update\" }"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{claim_id}}/status",
          "host": ["{{base_url}}"],
          "path": ["api","claims","{{claim_id}}","status"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status updated to PENDING_APPROVAL', () => {",
              "  pm.response.to.have.status(200);",
              "  const body = pm.response.json();",
              "  pm.expect((body.status||'').toUpperCase()).to.eql('PENDING_APPROVAL');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "10. Gửi phê duyệt EVM (KTV)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"claimId\": {{claim_id}},\n  \"submissionNotes\": \"Đề nghị phê duyệt thay thế pin\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/submit", "host": ["{{base_url}}"], "path": ["api","claims","submit"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [
        "pm.test('Submitted to EVM', () => pm.response.to.have.status(200));",
        "pm.test('Status PENDING_EVM_APPROVAL', () => pm.expect((pm.response.json().status||'').toUpperCase()).to.eql('PENDING_EVM_APPROVAL'));"
      ], "type": "text/javascript" } } ]
    },
    {
      "name": "11. EVM Phê duyệt (EVM_STAFF)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{evm_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"approvalNotes\": \"Đủ điều kiện bảo hành theo policy\",\n  \"warrantyCost\": 100000000,\n  \"approvalReason\": \"APPROVED_BY_POLICY\",\n  \"requiresPartsShipment\": false,\n  \"companyPaidCost\": 100000000\n}" },
        "url": { "raw": "{{base_url}}/api/evm/claims/{{claim_id}}/approve", "host": ["{{base_url}}"], "path": ["api","evm","claims","{{claim_id}}","approve"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [
        "pm.test('EVM approved', () => pm.response.to.have.status(200));",
        "const st = (pm.response.json().status||'').toUpperCase(); pm.collectionVariables.set('post_approve_status', st);",
        "pm.test('Status READY_FOR_REPAIR or WAITING_FOR_PARTS', () => pm.expect(['READY_FOR_REPAIR','WAITING_FOR_PARTS']).to.include(st));"
      ], "type": "text/javascript" } } ]
    },
    {
      "name": "12a. [OPTIONAL] KTV báo cáo vấn đề (PROBLEM_CONFLICT)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{tech_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"problemType\": \"PARTS_SHORTAGE\",\n  \"problemDescription\": \"Thiếu pin serial BAT001-2024-XXX, kho không có sẵn. Dự kiến cần 5 ngày để nhập hàng.\",\n  \"missingPartSerials\": [\"BAT001-2024-XXX\"],\n  \"estimatedResolutionDays\": 5\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{claim_id}}/report-problem",
          "host": ["{{base_url}}"],
          "path": ["api","claims","{{claim_id}}","report-problem"]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Skip this step if testing happy path (no problems)",
              "const testProblemScenario = pm.collectionVariables.get('test_problem_scenario');",
              "if (!testProblemScenario || testProblemScenario === 'false') {",
              "  postman.setNextRequest('12d. Không có vấn đề - chuyển READY_FOR_REPAIR');",
              "}"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Only run if testing problem scenario",
              "if (pm.collectionVariables.get('test_problem_scenario') === 'true') {",
              "  pm.test('Problem reported successfully', () => {",
              "    pm.response.to.have.status(200);",
              "    const res = pm.response.json();",
              "    pm.expect(res.status.toUpperCase()).to.eql('PROBLEM_CONFLICT');",
              "  });",
              "  console.log('✅ Problem reported, waiting for EVM resolution');",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "12b. [OPTIONAL] EVM giải quyết vấn đề (PROBLEM_SOLVED)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{evm_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"resolutionAction\": \"PARTS_SHIPPED\",\n  \"resolutionNotes\": \"Đã gửi pin BAT001-2024-009 qua DHL. Dự kiến đến ngày {{arrival_date}}\",\n  \"trackingNumber\": \"DHL123456789\",\n  \"estimatedArrival\": \"{{arrival_date}}\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/evm/claims/{{claim_id}}/resolve-problem",
          "host": ["{{base_url}}"],
          "path": ["api","evm","claims","{{claim_id}}","resolve-problem"]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Skip if not testing problem scenario",
              "if (pm.collectionVariables.get('test_problem_scenario') !== 'true') {",
              "  postman.setNextRequest('12d. Không có vấn đề - chuyển READY_FOR_REPAIR');",
              "}",
              "// Set arrival date (5 days from now)",
              "const arrivalDate = new Date();",
              "arrivalDate.setDate(arrivalDate.getDate() + 5);",
              "pm.collectionVariables.set('arrival_date', arrivalDate.toISOString().slice(0,10));"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.collectionVariables.get('test_problem_scenario') === 'true') {",
              "  pm.test('Problem resolved by EVM', () => {",
              "    pm.response.to.have.status(200);",
              "    const res = pm.response.json();",
              "    pm.expect(res.status.toUpperCase()).to.eql('PROBLEM_SOLVED');",
              "  });",
              "  console.log('✅ EVM resolved problem, technician can continue');",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "12c. [OPTIONAL] KTV xác nhận giải quyết OK (READY_FOR_REPAIR)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{tech_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"confirmed\": true,\n  \"nextAction\": \"READY_FOR_REPAIR\",\n  \"confirmationNotes\": \"Đã nhận pin mới, kiểm tra OK, sẵn sàng thay thế\"\n}"
        },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/confirm-resolution", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","confirm-resolution"] }
      },
      "event": [
        { "listen": "prerequest", "script": { "type": "text/javascript", "exec": [
          "if (pm.collectionVariables.get('test_problem_scenario') !== 'true') {",
          "  postman.setNextRequest('12d. Không có vấn đề - chuyển READY_FOR_REPAIR (KTV)');",
          "}"
        ] } },
        { "listen": "test", "script": { "type": "text/javascript", "exec": [
          "if (pm.collectionVariables.get('test_problem_scenario') === 'true') {",
          "  pm.test('Resolution confirmed, ready for repair', () => {",
          "    pm.response.to.have.status(200);",
          "    const res = pm.response.json();",
          "    pm.expect(res.status.toUpperCase()).to.eql('READY_FOR_REPAIR');",
          "  });",
          "  console.log('✅ Technician confirmed resolution, proceeding to work order');",
          "}"
        ] } }
      ]
    },
    {
      "name": "12d. Không có vấn đề - chuyển READY_FOR_REPAIR (KTV)",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{ \n  \"status\": \"READY_FOR_REPAIR\",\n  \"statusNote\": \"Mọi thứ sẵn sàng, không có vấn đề phát sinh\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/status", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","status"] }
      },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [
        "pm.test('Status updated to READY_FOR_REPAIR', () => {",
        "  pm.response.to.have.status(200);",
        "  const res = pm.response.json();",
        "  pm.expect(res.status.toUpperCase()).to.eql('READY_FOR_REPAIR');",
        "});",
        "console.log('✅ Claim ready for repair, can create work order');"
      ] } } ]
    },
    {
      "name": "13. Tạo Work Order (SC_STAFF)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"claimId\": {{claim_id}},\n  \"technicianId\": {{tech_user_id}},\n  \"description\": \"Thay pack pin theo phê duyệt\",\n  \"estimatedLaborHours\": 8\n}" },
        "url": { "raw": "{{base_url}}/api/work-orders/create", "host": ["{{base_url}}"], "path": ["api","work-orders","create"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [
        "pm.test('Work order created', () => pm.response.to.have.status(201));",
        "const wo = pm.response.json(); pm.collectionVariables.set('work_order_id', wo.id || wo.workOrderId);",
        "pm.test('Work order ID captured', () => pm.expect(pm.collectionVariables.get('work_order_id')).to.exist);"
      ], "type": "text/javascript" } } ]
    },
    {
      "name": "14. KTV bắt đầu sửa chữa (start WO)",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" } ],
        "url": { "raw": "{{base_url}}/api/work-orders/{{work_order_id}}/start", "host": ["{{base_url}}"], "path": ["api","work-orders","{{work_order_id}}","start"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('WO started', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },
    {
      "name": "15. KTV thay linh kiện (replace SN)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"oldSerialNumber\": \"{{old_serial}}\",\n  \"newSerialNumber\": \"{{new_serial}}\",\n  \"vehicleVin\": \"{{vin}}\",\n  \"workOrderId\": {{work_order_id}},\n  \"reason\": \"Warranty replacement\",\n  \"notes\": \"Cập nhật cấu hình xe theo SN mới\"\n}" },
        "url": { "raw": "{{base_url}}/api/part-serials/replace", "host": ["{{base_url}}"], "path": ["api","part-serials","replace"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('Part replaced', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },
    {
      "name": "16. Hoàn thành Work Order với statistics",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" } ],
        "url": { "raw": "{{base_url}}/api/work-orders/{{work_order_id}}/complete-with-stats?result=Thay%20pin%20hoan%20tat%2C%20test%20OK&laborHours=8", "host": ["{{base_url}}"], "path": ["api","work-orders","{{work_order_id}}","complete-with-stats"], "query": [ {"key": "result", "value": "Thay pin hoan tat, test OK"}, {"key": "laborHours", "value": "8"} ] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('Work order completed', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },
    {
      "name": "17. Hoàn tất sửa chữa -> FINAL_INSPECTION",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"completedAt\": \"{{now_iso}}\",\n  \"repairSummary\": \"Thay pack pin {{new_serial}}, test sạc/điện áp OK\",\n  \"repairNotes\": \"Lưu ý trả lại hàng hỏng về hãng\",\n  \"partsReplaced\": [\"{{new_serial}}\"],\n  \"totalLaborHours\": 8,\n  \"qualityCheckResults\": \"PASS\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/complete-repair", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","complete-repair"] }
      },
      "event": [
        { "listen": "prerequest", "script": { "exec": [ "pm.collectionVariables.set('now_iso', new Date().toISOString());" ], "type": "text/javascript" } },
        { "listen": "test", "script": { "exec": [
          "pm.test('FINAL_INSPECTION status', () => { pm.response.to.have.status(200); pm.expect((pm.response.json().status||'').toUpperCase()).to.eql('FINAL_INSPECTION'); });"
        ], "type": "text/javascript" } }
      ]
    },
    {
      "name": "18. Final Inspection (SC_STAFF)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"inspectedAt\": \"{{now_iso}}\",\n  \"inspectionPassed\": true,\n  \"inspectionNotes\": \"Tổng thể đạt yêu cầu\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/final-inspection", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","final-inspection"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('Final inspection OK', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },
    {
      "name": "19. Notify Customer (SC_STAFF)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"claimId\": {{claim_id}},\n  \"notificationType\": \"REPAIR_COMPLETED\",\n  \"channels\": [\"SMS\", \"EMAIL\"],\n  \"message\": \"Xe đã sửa xong, mời anh/chị đến nhận xe.\",\n  \"includeRepairSummary\": true\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/notify-customer", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","notify-customer"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('Customer notified', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },
    {
      "name": "20. Handover Vehicle (SC_STAFF)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"handoverAt\": \"{{now_iso}}\",\n  \"customerSignature\": \"MICHAEL_T\",\n  \"handoverNotes\": \"Khách nhận xe, đồng ý chi phí\",\n  \"customerFeedback\": \"Hài lòng\",\n  \"customerSatisfied\": true,\n  \"handoverLocation\": \"SC01-HN\",\n  \"vehicleConditionNotes\": \"Sạch sẽ\",\n  \"warrantyInfoProvided\": \"Yes\",\n  \"followUpRequired\": \"No\",\n  \"handoverPersonnel\": \"Alice Johnson\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/handover", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","handover"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('Handover done', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },
    {
      "name": "21. Close Claim (SC_STAFF)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw",
        "raw": "{\n  \"closedAt\": \"{{now_iso}}\",\n  \"closureReason\": \"COMPLETED\",\n  \"closureSummary\": \"Hoàn tất bảo hành. Hãng chi trả 100.000.000đ\",\n  \"lessonsLearned\": \"Kiểm tra cell sớm\",\n  \"followUpActions\": \"Theo dõi 1 tuần\",\n  \"customerSatisfied\": true,\n  \"finalNotes\": \"Cập nhật kho: SN mới dùng, SN cũ chờ trả hãng\",\n  \"closedBy\": \"{{sc_staff_username}}\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/close", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","close"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [
        "pm.test('Claim closed', () => { pm.response.to.have.status(200); pm.expect((pm.response.json().status||'').toUpperCase()).to.eql('CLOSED'); });"
      ], "type": "text/javascript" } } ]
    },
    {
      "name": "22. Xem Claim Summary (EVM/SC)",
      "request": {
        "method": "GET",
        "header": [ { "key": "Authorization", "value": "Bearer {{evm_token}}" } ],
        "url": { "raw": "{{base_url}}/api/claims/{{claim_id}}/summary", "host": ["{{base_url}}"], "path": ["api","claims","{{claim_id}}","summary"] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('Claim summary retrieved', () => pm.response.to.have.status(200));" ], "type": "text/javascript" } } ]
    },

    {
      "name": "ALT-1. Tạo Claim mới cho test Rejection",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"customerName\": \"Test Rejection Customer\",\n  \"customerPhone\": \"0999888777\",\n  \"customerEmail\": \"rejection.test@email.com\",\n  \"customerAddress\": \"Test Address\",\n  \"vin\": \"{{vin}}\",\n  \"mileageKm\": 26000,\n  \"claimTitle\": \"Test claim for rejection flow\",\n  \"reportedFailure\": \"Claim thiếu thông tin để test rejection\",\n  \"assignedTechnicianId\": {{tech_user_id}},\n  \"flow\": \"DRAFT\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/draft",
          "host": ["{{base_url}}"],
          "path": ["api","claims","draft"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Rejection test claim created', () => pm.response.to.have.status(201));",
              "const c = pm.response.json();",
              "pm.collectionVariables.set('rejection_claim_id', c.id);",
              "pm.collectionVariables.set('rejection_claim_number', c.claimNumber);"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "ALT-1.5. Set status -> PENDING_APPROVAL (KTV)",
      "request": {
        "method": "PUT",
        "header": [
          { "key": "Authorization", "value": "Bearer {{tech_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \n  \"status\": \"PENDING_APPROVAL\",\n  \"statusNote\": \"Set to PENDING_APPROVAL before ALT-2\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{rejection_claim_id}}/status",
          "host": ["{{base_url}}"],
          "path": ["api","claims","{{rejection_claim_id}}","status"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status set to PENDING_APPROVAL', () => {",
              "  pm.response.to.have.status(200);",
              "  const res = pm.response.json();",
              "  pm.expect((res.status||'').toUpperCase()).to.eql('PENDING_APPROVAL');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "ALT-2. Submit claim cho EVM",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{tech_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": {{rejection_claim_id}},\n  \"submissionNotes\": \"Submit thiếu diagnostic data để test rejection\"\n}" }
        ,
        "url": {
          "raw": "{{base_url}}/api/claims/submit",
          "host": ["{{base_url}}"],
          "path": ["api","claims","submit"]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Ensure rejection claim is PENDING_APPROVAL before submit",
              "pm.sendRequest({",
              "  url: pm.collectionVariables.get('base_url') + '/api/claims/' + pm.collectionVariables.get('rejection_claim_id') + '/status',",
              "  method: 'PUT',",
              "  header: [",
              "    { key: 'Content-Type', value: 'application/json' },",
              "    { key: 'Authorization', value: 'Bearer ' + pm.collectionVariables.get('tech_token') }",
              "  ],",
              "  body: { mode: 'raw', raw: JSON.stringify({ status: 'PENDING_APPROVAL', statusNote: 'Auto-set before ALT-2 submit' }) }",
              "}, function (err, res) {",
              "  if (err) { console.log('ALT-2 pre-submit failed', err); } else { try { console.log('ALT-2 pre-submit status', res.json().status); } catch(e){ console.log('ALT-2 pre-submit response'); } }",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "ALT-3. EVM Từ chối claim (REJECT)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{evm_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"rejectionReason\": \"INSUFFICIENT_EVIDENCE\",\n  \"rejectionNotes\": \"Thiếu diagnostic data chi tiết. Vui lòng bổ sung:\\n1. Battery voltage test results\\n2. Cell balance report\\n3. BMS error log\\n4. Photos of error display\",\n  \"requiredActions\": [\"Provide diagnostic data\", \"Upload test results\", \"Add photos\"]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/evm/claims/{{rejection_claim_id}}/reject",
          "host": ["{{base_url}}"],
          "path": ["api","evm","claims","{{rejection_claim_id}}","reject"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Claim submitted (ALT-2) returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Status becomes EVM_REJECTED (ALT-2)', () => {",
              "  const st = (pm.response.json().status||'').toUpperCase();",
              "  pm.expect(st).to.eql('EVM_REJECTED');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "ALT-4. KTV Resubmit claim sau khi bổ sung",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{tech_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"revisedDiagnostic\": \"Đã bổ sung đầy đủ thông tin:\\n- Battery voltage: 298V (low)\\n- Cell imbalance: 40mV\\n- BMS error: B001 - Cell undervoltage\\n- Test date: {{today_date}}\",\n  \"additionalEvidence\": [\"/uploads/battery_test_{{rejection_claim_number}}.pdf\", \"/uploads/error_photo_{{rejection_claim_number}}.jpg\"],\n  \"responseToRejection\": \"Đã thực hiện đầy đủ các yêu cầu:\\n1. ✅ Battery voltage test results - attached\\n2. ✅ Cell balance report - attached\\n3. ✅ BMS error log - included in diagnostic\\n4. ✅ Photos of error display - uploaded\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{rejection_claim_id}}/resubmit",
          "host": ["{{base_url}}"],
          "path": ["api","claims","{{rejection_claim_id}}","resubmit"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Claim resubmitted successfully', () => pm.response.to.have.status(200));",
              "const res = pm.response.json();",
              "pm.test('Status back to PENDING_EVM_APPROVAL', () => {",
              "  pm.expect((res.status||'').toUpperCase()).to.eql('PENDING_EVM_APPROVAL');",
              "});",
              "pm.test('Resubmit count = 1', () => {",
              "  pm.expect(res.resubmitCount || 0).to.eql(1);",
              "});",
              "pm.collectionVariables.set('resubmit_count', res.resubmitCount || 1);"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "ALT-5a. EVM Approve sau khi resubmit (Happy ending)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{evm_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"approvalNotes\": \"Đã bổ sung đầy đủ thông tin. Chấp thuận bảo hành.\",\n  \"warrantyCost\": 100000000,\n  \"approvalReason\": \"APPROVED_AFTER_RESUBMIT\",\n  \"requiresPartsShipment\": false,\n  \"companyPaidCost\": 100000000\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/evm/claims/{{rejection_claim_id}}/approve",
          "host": ["{{base_url}}"],
          "path": ["api","evm","claims","{{rejection_claim_id}}","approve"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Claim approved after resubmit', () => pm.response.to.have.status(200));",
              "const res = pm.response.json();",
              "pm.test('Status EVM_APPROVED', () => {",
              "  pm.expect((res.status||'').toUpperCase()).to.include('APPROVED');",
              "});",
              "console.log('✅ Resubmit successful - claim approved');"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },


    {
      "name": "DBL-1. Tạo claim cho double rejection test",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{sc_staff_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"customerName\": \"Double Reject Test\",\n  \"customerPhone\": \"0888777666\",\n  \"customerEmail\": \"double.reject@test.com\",\n  \"customerAddress\": \"Test Address\",\n  \"vin\": \"{{vin}}\",\n  \"mileageKm\": 27000,\n  \"claimTitle\": \"Test double rejection\",\n  \"reportedFailure\": \"Claim không đủ điều kiện bảo hành\",\n  \"assignedTechnicianId\": {{tech_user_id}},\n  \"flow\": \"DRAFT\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/draft",
          "host": ["{{base_url}}"],
          "path": ["api","claims","draft"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Double rejection test claim created', () => pm.response.to.have.status(201));",
              "const c = pm.response.json();",
              "pm.collectionVariables.set('double_reject_claim_id', c.id);"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "DBL-2. Submit lần 1",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{tech_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": {{double_reject_claim_id}},\n  \"submissionNotes\": \"Submit lần 1\"\n}" },
        "url": {
          "raw": "{{base_url}}/api/claims/submit",
          "host": ["{{base_url}}"],
          "path": ["api","claims","submit"]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Ensure double-reject claim is in PENDING_APPROVAL before submit",
              "pm.sendRequest({",
              "  url: pm.collectionVariables.get('base_url') + '/api/claims/' + pm.collectionVariables.get('double_reject_claim_id') + '/status',",
              "  method: 'PUT',",
              "  header: [",
              "    { key: 'Content-Type', value: 'application/json' },",
              "    { key: 'Authorization', value: 'Bearer ' + pm.collectionVariables.get('tech_token') }",
              "  ],",
              "  body: { mode: 'raw', raw: JSON.stringify({ status: 'PENDING_APPROVAL', statusNote: 'Auto-set before submit' }) }",
              "}, function (err, res) {",
              "  if (err) { console.log('DBL-2 pre-submit failed', err); } else { try { console.log('DBL-2 pre-submit status', res.json().status); } catch(e){ console.log('DBL-2 pre-submit response'); } }",
              "});"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('First submission OK', () => pm.response.to.have.status(200));"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "DBL-3. EVM Reject lần 1",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{evm_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"rejectionReason\": \"OUT_OF_WARRANTY\",\n  \"rejectionNotes\": \"Xe đã hết bảo hành. Vui lòng kiểm tra lại warranty_end date.\",\n  \"requiredActions\": [\"Verify warranty status\"]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/evm/claims/{{double_reject_claim_id}}/reject",
          "host": ["{{base_url}}"],
          "path": ["api","evm","claims","{{double_reject_claim_id}}","reject"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('First rejection', () => pm.response.to.have.status(200));",
              "pm.test('Status EVM_REJECTED', () => {",
              "  pm.expect((pm.response.json().status||'').toUpperCase()).to.eql('EVM_REJECTED');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "DBL-4. Resubmit lần 1",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{tech_token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"revisedDiagnostic\": \"Đã kiểm tra lại: xe vẫn còn trong thời hạn bảo hành đến {{warranty_end}}\",\n  \"additionalEvidence\": [\"/uploads/warranty_card.jpg\"],\n  \"responseToRejection\": \"Warranty end date: {{warranty_end}}, vẫn còn hiệu lực\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{double_reject_claim_id}}/resubmit",
          "host": ["{{base_url}}"],
          "path": ["api","claims","{{double_reject_claim_id}}","resubmit"]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Get warranty end from vehicle",
              "pm.collectionVariables.set('warranty_end', '2026-03-01');"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Resubmitted', () => pm.response.to.have.status(200));",
              "pm.test('Resubmit count = 1', () => {",
              "  pm.expect(pm.response.json().resubmitCount || 0).to.eql(1);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "DBL-5. EVM Reject lần 2 (FINAL)",
      "request": { "method": "POST", "header": [ { "key": "Authorization", "value": "Bearer {{evm_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"rejectionReason\": \"NOT_COVERED_BY_WARRANTY\",\n  \"rejectionNotes\": \"Lỗi không thuộc phạm vi bảo hành (customer abuse detected). Từ chối lần 2 - FINAL.\",\n  \"requiredActions\": [\"Customer self-pay or third-party repair\"],\n  \"isFinalRejection\": true\n}" },
        "url": { "raw": "{{base_url}}/api/evm/claims/{{double_reject_claim_id}}/reject", "host": ["{{base_url}}"], "path": ["api","evm","claims","{{double_reject_claim_id}}","reject"] }
      },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [
        "pm.test('Second (final) rejection', () => pm.response.to.have.status(200));",
        "const res = pm.response.json();",
        "pm.test('Status EVM_REJECTED', () => { pm.expect((res.status||'').toUpperCase()).to.eql('EVM_REJECTED'); });",
        "pm.test('Cannot resubmit anymore', () => { pm.expect(res.canResubmit).to.be.false; });"
      ] } } ]
    },
    {
      "name": "DBL-6. KTV đánh dấu INACTIVE (delete claim)",
      "request": { "method": "PUT", "header": [ { "key": "Authorization", "value": "Bearer {{tech_token}}" }, { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"status\": \"INACTIVE\",\n  \"statusNote\": \"Claim bị từ chối 2 lần, đánh dấu inactive theo yêu cầu EVM\",\n  \"deletionReason\": \"REJECTED_BY_EVM_TWICE\"\n}" },
        "url": { "raw": "{{base_url}}/api/claims/{{double_reject_claim_id}}/status", "host": ["{{base_url}}"], "path": ["api","claims","{{double_reject_claim_id}}","status"] }
      },
      "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [
        "pm.test('Claim marked as INACTIVE', () => {",
        "  pm.response.to.have.status(200);",
        "  const res = pm.response.json();",
        "  pm.expect((res.status||'').toUpperCase()).to.eql('INACTIVE');",
        "});",
        "console.log('✅ Double rejection flow complete - claim archived as INACTIVE');"
      ] } } ]
    }
  ]
}
