{
  "info": {
    "name": "Expired Warranty Flow Tests",
    "description": "Test flow unhappy khi xe hết hạn bảo hành - phải sử dụng phụ tùng bên thứ 3\n\n✅ XE HẾT HẠN BẢO HÀNH CÓ SẴN TRONG data.sql:\n- EXPIRED001 (warranty_end = '2023-01-01') - Đã hết hạn\n- EXPIRED002 (warranty_end = '2024-06-01') - Có thể đã hết hạn\n- EXPIRED003 (warranty_end = '2023-12-01') - Đã hết hạn\n- EXPIRED004 (warranty_end = '2024-03-15') - Có thể đã hết hạn\n- TEST-VIN-004 (warranty_end = '2024-01-10') - Có thể đã hết hạn\n- TEST-VIN-005 (warranty_end = '2024-03-15') - Có thể đã hết hạn\n- TEST-VIN-006 (warranty_end = '2024-12-01') - Có thể đã hết hạn\n\n⚠️ LƯU Ý:\n1. VIN mặc định: EXPIRED001 (đã hết hạn từ 2023-01-01)\n2. Cần có Third Party Part trong hệ thống (test 11 sẽ lấy, nếu không có cần tạo trước)\n3. Service Center ID: 1 (hoặc thay đổi trong test 11)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080",
      "type": "string"
    },
    {
      "key": "expired_vin",
      "value": "EXPIRED001",
      "type": "string",
      "description": "VIN của xe hết hạn bảo hành - EXPIRED001 (warranty_end = '2023-01-01') hoặc TEST-VIN-004 (warranty_end = '2024-01-10')"
    }
  ],
  "item": [
    {
      "name": "1. Login SC Staff",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"SC Staff login successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    var token = jsonData.token || jsonData.accessToken;",
              "    pm.collectionVariables.set(\"sc_staff_token\", token);",
              "    pm.collectionVariables.set(\"sc_staff_id\", jsonData.userId || jsonData.id);",
              "    pm.collectionVariables.set(\"sc_staff_username\", jsonData.username);",
              "    console.log(\"✅ SC Staff Token saved\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"sc_staff1\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "2. Login Technician",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Technician login successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    var token = jsonData.token || jsonData.accessToken;",
              "    pm.collectionVariables.set(\"tech_token\", token);",
              "    pm.collectionVariables.set(\"tech_user_id\", jsonData.userId || jsonData.id);",
              "    pm.collectionVariables.set(\"tech_username\", jsonData.username);",
              "    console.log(\"✅ Technician Token saved\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"tech2\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "3. (Optional) Get Vehicle Info - Kiểm tra warrantyEnd",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Get vehicle info successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    console.log(\"Vehicle warrantyEnd: \" + jsonData.warrantyEnd);",
              "    console.log(\"Vehicle warrantyStart: \" + jsonData.warrantyStart);",
              "    ",
              "    if (jsonData.warrantyEnd) {",
              "        var warrantyEndDate = new Date(jsonData.warrantyEnd);",
              "        var today = new Date();",
              "        if (warrantyEndDate < today) {",
              "            console.log(\"✅ Vehicle warranty đã hết hạn\");",
              "        } else {",
              "            console.log(\"⚠️ WARNING: Vehicle warranty chưa hết hạn. Cần update warrantyEnd trong DB.\");",
              "            console.log(\"SQL: UPDATE vehicles SET warranty_end = '2020-01-01' WHERE vin = '\" + jsonData.vin + \"'\");",
              "        }",
              "    }",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicles/vin/{{expired_vin}}",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicles", "vin", "{{expired_vin}}"]
        }
      }
    },
    {
      "name": "4. Tạo Claim Draft cho xe hết hạn bảo hành",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Claim draft created successfully\", function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "if (pm.response.code === 201) {",
              "    var jsonData = pm.response.json();",
              "    pm.collectionVariables.set(\"expired_claim_id\", jsonData.id);",
              "    pm.collectionVariables.set(\"expired_claim_number\", jsonData.claimNumber);",
              "    console.log(\"✅ Expired Warranty Claim ID: \" + jsonData.id);",
              "    console.log(\"✅ Claim Number: \" + jsonData.claimNumber);",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"customerName\": \"Customer Expired Warranty\",\n  \"customerPhone\": \"0999888777\",\n  \"customerEmail\": \"expired.warranty@test.com\",\n  \"customerAddress\": \"123 Test Street\",\n  \"vin\": \"{{expired_vin}}\",\n  \"mileageKm\": 50000,\n  \"claimTitle\": \"Claim cho xe hết hạn bảo hành\",\n  \"reportedFailure\": \"Xe hết hạn bảo hành, cần sửa chữa với phụ tùng bên thứ 3\",\n  \"assignedTechnicianId\": {{tech_user_id}},\n  \"flow\": \"DRAFT\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/draft",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "draft"]
        }
      }
    },
    {
      "name": "5. Convert Draft to Intake",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Draft converted to intake successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status should be OPEN\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql(\"OPEN\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}/to-intake",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}", "to-intake"]
        }
      }
    },
    {
      "name": "6. Check Warranty Eligibility (Sẽ trả về false)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Warranty eligibility checked successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Warranty should be expired (eligible = false)\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.eligible).to.eql(false);",
              "    console.log(\"Warranty eligible: \" + jsonData.eligible);",
              "    console.log(\"Reasons: \" + JSON.stringify(jsonData.reasons));",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}/warranty-eligibility",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}", "warranty-eligibility"]
        }
      }
    },
    {
      "name": "7. Update Diagnostic - Đánh dấu không đủ điều kiện bảo hành",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Diagnostic updated successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status should be PENDING_CUSTOMER_APPROVAL\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql(\"PENDING_CUSTOMER_APPROVAL\");",
              "    console.log(\"✅ Claim chuyển sang PENDING_CUSTOMER_APPROVAL\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{tech_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": {{expired_claim_id}},\n  \"initialDiagnosis\": \"Xe hết hạn bảo hành, cần sửa chữa với phụ tùng bên thứ 3\",\n  \"diagnosticDetails\": \"Kiểm tra kỹ thuật: Xe đã vượt quá thời hạn bảo hành. Khách hàng cần xác nhận sử dụng phụ tùng bên thứ 3\",\n  \"reportedFailure\": \"Xe hết hạn bảo hành, cần sửa chữa\",\n  \"isWarrantyEligible\": false,\n  \"warrantyEligibilityAssessment\": \"Warranty đã hết hạn. Không đủ điều kiện bảo hành\",\n  \"warrantyEligibilityNotes\": \"Xe cần sửa chữa với phụ tùng bên thứ 3\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}/diagnostic",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}", "diagnostic"]
        }
      }
    },
    {
      "name": "8. Customer Approval - Đồng ý sử dụng phụ tùng bên thứ 3",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Customer approval processed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status should be READY_FOR_REPAIR after approval\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql(\"READY_FOR_REPAIR\");",
              "    console.log(\"✅ Khách hàng đồng ý, claim chuyển sang READY_FOR_REPAIR\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}/customer-approval?approved=true&notes=Khách hàng đồng ý sử dụng phụ tùng bên thứ 3",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}", "customer-approval"],
          "query": [
            {
              "key": "approved",
              "value": "true"
            },
            {
              "key": "notes",
              "value": "Khách hàng đồng ý sử dụng phụ tùng bên thứ 3"
            }
          ]
        }
      }
    },
    {
      "name": "9. Get Claim Details - Lấy vehicleId",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Get claim details successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.vehicle && jsonData.vehicle.id) {",
              "        pm.collectionVariables.set(\"expired_vehicle_id\", jsonData.vehicle.id);",
              "        console.log(\"✅ Vehicle ID: \" + jsonData.vehicle.id);",
              "    }",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}"]
        }
      }
    },
    {
      "name": "10. Tạo Work Order",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Work order created successfully\", function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "if (pm.response.code === 201) {",
              "    var jsonData = pm.response.json();",
              "    pm.collectionVariables.set(\"expired_work_order_id\", jsonData.id);",
              "    console.log(\"✅ Work Order ID: \" + jsonData.id);",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{tech_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": {{expired_claim_id}},\n  \"technicianId\": {{tech_user_id}},\n  \"startTime\": null,\n  \"description\": \"Work order cho xe hết hạn bảo hành - sử dụng phụ tùng bên thứ 3\",\n  \"workOrderType\": \"SC\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/work-orders/create",
          "host": ["{{base_url}}"],
          "path": ["api", "work-orders", "create"]
        }
      }
    },
    {
      "name": "11. Get Third Party Parts (Service Center)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Get third party parts successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData && jsonData.length > 0) {",
              "        pm.collectionVariables.set(\"third_party_part_id\", jsonData[0].id);",
              "        console.log(\"✅ Third Party Part ID: \" + jsonData[0].id);",
              "        console.log(\"Part Name: \" + jsonData[0].name);",
              "    } else {",
              "        console.log(\"⚠️ No third party parts available. Need to create one first.\");",
              "    }",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/third-party-parts/service-center/1",
          "host": ["{{base_url}}"],
          "path": ["api", "third-party-parts", "service-center", "1"]
        }
      }
    },
    {
      "name": "12. Reserve Third Party Parts Serial",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Third party parts reserved successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.reservedSerials && jsonData.reservedSerials.length > 0) {",
              "        pm.collectionVariables.set(\"third_party_serial_number\", jsonData.reservedSerials[0].serialNumber);",
              "        console.log(\"✅ Reserved Serial: \" + jsonData.reservedSerials[0].serialNumber);",
              "    }",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": {{expired_claim_id}},\n  \"vehicleId\": {{expired_vehicle_id}},\n  \"parts\": [\n    {\n      \"thirdPartyPartId\": {{third_party_part_id}},\n      \"quantity\": 1\n    }\n  ]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/third-party-parts/serials/reserve",
          "host": ["{{base_url}}"],
          "path": ["api", "third-party-parts", "serials", "reserve"]
        }
      }
    },
    {
      "name": "13. Start Work Order",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Work order started successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Work order startTime should be set\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.startTime).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{tech_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/work-orders/{{expired_work_order_id}}/start",
          "host": ["{{base_url}}"],
          "path": ["api", "work-orders", "{{expired_work_order_id}}", "start"]
        }
      }
    },
    {
      "name": "14. Add Third Party Part to Work Order",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Third party part added to work order successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{tech_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"partSource\": \"THIRD_PARTY\",\n  \"thirdPartyPartId\": {{third_party_part_id}},\n  \"thirdPartySerialNumber\": \"{{third_party_serial_number}}\",\n  \"quantity\": 1,\n  \"unitCost\": 500000,\n  \"notes\": \"Phụ tùng bên thứ 3 cho xe hết hạn bảo hành\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/work-orders/{{expired_work_order_id}}/add-part",
          "host": ["{{base_url}}"],
          "path": ["api", "work-orders", "{{expired_work_order_id}}", "add-part"]
        }
      }
    },
    {
      "name": "15. Complete Work Order",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Work order completed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Work order status should be DONE\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql(\"DONE\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{tech_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/work-orders/{{expired_work_order_id}}/complete-with-stats?result=Đã thay thế phụ tùng bên thứ 3 thành công&laborHours=3.0",
          "host": ["{{base_url}}"],
          "path": ["api", "work-orders", "{{expired_work_order_id}}", "complete-with-stats"],
          "query": [
            {
              "key": "result",
              "value": "Đã thay thế phụ tùng bên thứ 3 thành công"
            },
            {
              "key": "laborHours",
              "value": "3.0"
            }
          ]
        }
      }
    },
    {
      "name": "16. Complete Repair",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Repair completed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status should be FINAL_INSPECTION\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql(\"FINAL_INSPECTION\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{tech_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"repairSummary\": \"Đã hoàn tất sửa chữa với phụ tùng bên thứ 3 cho xe hết hạn bảo hành\",\n  \"repairNotes\": \"Sửa chữa thành công, xe hoạt động bình thường\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}/complete-repair",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}", "complete-repair"]
        }
      }
    },
    {
      "name": "17. Final Inspection",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Final inspection completed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status should be READY_FOR_HANDOVER after pass\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql(\"READY_FOR_HANDOVER\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"inspectionPassed\": true,\n  \"inspectionNotes\": \"Kiểm tra chất lượng công việc đạt yêu cầu. Phụ tùng bên thứ 3 hoạt động tốt\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}/final-inspection",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}", "final-inspection"]
        }
      }
    },
    {
      "name": "18. Handover Vehicle",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "pm.collectionVariables.set('now_iso', new Date().toISOString());"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Vehicle handover completed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status should be CLAIM_DONE when customer satisfied\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql(\"CLAIM_DONE\");",
              "    console.log(\"✅ Hoàn tất flow hết hạn bảo hành với phụ tùng bên thứ 3\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"handoverAt\": \"{{now_iso}}\",\n  \"customerSignature\": \"CUSTOMER_SIGN\",\n  \"handoverNotes\": \"Khách hàng nhận xe sau sửa chữa với phụ tùng bên thứ 3\",\n  \"customerFeedback\": \"Hài lòng với dịch vụ\",\n  \"customerSatisfied\": true,\n  \"handoverLocation\": \"SC01-HN\",\n  \"vehicleConditionNotes\": \"Xe sạch sẽ, hoạt động tốt\",\n  \"warrantyInfoProvided\": \"Đã thông báo về phụ tùng bên thứ 3\",\n  \"followUpRequired\": \"Không\",\n  \"handoverPersonnel\": \"SC Staff\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}/handover",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}", "handover"]
        }
      }
    },
    {
      "name": "19. (Optional) Get Claim Summary",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Claim summary retrieved successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Summary should show third party parts cost\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.totalThirdPartyPartsCost) {",
              "        console.log(\"Total Third Party Parts Cost: \" + jsonData.totalThirdPartyPartsCost);",
              "    }",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/claims/{{expired_claim_id}}/summary",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{expired_claim_id}}", "summary"]
        }
      }
    }
  ]
}

