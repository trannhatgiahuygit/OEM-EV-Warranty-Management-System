{
  "info": {
    "name": "Warranty Claim Flow Tests",
    "description": "Test toàn bộ quy trình bảo hành từ tạo claim đến hoàn tất",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. Login SC Staff",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"SC Staff login successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    var token = jsonData.token || jsonData.accessToken;",
              "    pm.collectionVariables.set(\"sc_staff_token\", token);",
              "    pm.collectionVariables.set(\"sc_staff_id\", jsonData.userId || jsonData.id);",
              "    console.log(\"✅ SC Staff Token saved\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"sc_staff1\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "2. Create Warranty Claim - Draft",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Claim created successfully\", function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "if (pm.response.code === 201) {",
              "    var jsonData = pm.response.json();",
              "    pm.collectionVariables.set(\"claim_id\", jsonData.id);",
              "    pm.collectionVariables.set(\"claim_number\", jsonData.claimNumber);",
              "    console.log(\"✅ Claim ID: \" + jsonData.id);",
              "    console.log(\"✅ Claim Number: \" + jsonData.claimNumber);",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"vin\": \"1HGBH41JXMN109186\",\n  \"customerName\": \"Michael Thompson\",\n  \"customerEmail\": \"michael.t@email.com\",\n  \"customerPhone\": \"0987654321\",\n  \"customerAddress\": \"123 Main St, New York, NY 10001\",\n  \"reportedFailure\": \"Battery not charging properly, shows error code B001\",\n  \"initialDiagnosis\": \"Potential battery management system failure\",\n  \"mileageKm\": 25000,\n  \"flow\": \"draft\",\n  \"assignedTechnicianId\": 4\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/intake",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "intake"]
        }
      }
    },
    {
      "name": "3. Update Claim Diagnostic",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Diagnostic updated successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Diagnostic details updated\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.diagnosticDetails).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": {{claim_id}},\n  \"diagnosticDetails\": \"Battery management system diagnostic completed. Found faulty temperature sensor in battery pack #2. Requires replacement of sensor and recalibration.\",\n  \"estimatedRepairCost\": 250.00,\n  \"estimatedRepairTime\": \"2-3 hours\",\n  \"requiredParts\": [\n    {\n      \"partId\": 6,\n      \"partName\": \"Battery Temperature Sensor\",\n      \"quantity\": 1\n    }\n  ],\n  \"diagnosticImages\": [\n    \"/uploads/diagnostics/sensor_fault.jpg\",\n    \"/uploads/diagnostics/battery_pack_2.jpg\"\n  ]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/diagnostic",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "diagnostic"]
        }
      }
    },
    {
      "name": "4. Mark Claim Ready for Submission",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Claim marked ready for submission\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Status updated to PENDING_EVM_APPROVAL\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.include(\"PENDING_EVM_APPROVAL\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": {{claim_id}}\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{claim_id}}/ready-for-submission",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{claim_id}}", "ready-for-submission"]
        }
      }
    },
    {
      "name": "5. Login EVM Staff",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"EVM Staff login successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    var token = jsonData.token || jsonData.accessToken;",
              "    pm.collectionVariables.set(\"evm_token\", token);",
              "    pm.collectionVariables.set(\"evm_id\", jsonData.userId || jsonData.id);",
              "    console.log(\"✅ EVM Staff Token saved\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"evm_staff1\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "6. Get Pending Claims for EVM Review",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Get pending claims successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Pending claims list present\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.content || jsonData).to.be.an('array');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{evm_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/evm/claims/pending?page=0&size=10",
          "host": ["{{base_url}}"],
          "path": ["api", "evm", "claims", "pending"],
          "query": [
            {
              "key": "page",
              "value": "0"
            },
            {
              "key": "size",
              "value": "10"
            }
          ]
        }
      }
    },
    {
      "name": "7. EVM Review Claim Details",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Get claim details for review successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim details present\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.id).to.exist;",
              "    pm.expect(jsonData.vehicle).to.exist;",
              "    pm.expect(jsonData.customer).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{evm_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/evm/claims/{{claim_id}}/review",
          "host": ["{{base_url}}"],
          "path": ["api", "evm", "claims", "{{claim_id}}", "review"]
        }
      }
    },
    {
      "name": "8. EVM Approve Claim",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Claim approved successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Status updated to EVM_APPROVED\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.include(\"EVM_APPROVED\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{evm_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"warrantyCost\": 250.00,\n  \"companyPaidCost\": 250.00,\n  \"approvalNotes\": \"Battery temperature sensor replacement approved. Standard warranty repair.\",\n  \"estimatedRepairTime\": \"2-3 hours\",\n  \"priority\": \"NORMAL\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/evm/claims/{{claim_id}}/approve",
          "host": ["{{base_url}}"],
          "path": ["api", "evm", "claims", "{{claim_id}}", "approve"]
        }
      }
    },
    {
      "name": "9. Login SC Technician",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"SC Technician login successful\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    var token = jsonData.token || jsonData.accessToken;",
              "    pm.collectionVariables.set(\"technician_token\", token);",
              "    pm.collectionVariables.set(\"technician_id\", jsonData.userId || jsonData.id);",
              "    console.log(\"✅ SC Technician Token saved\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"tech1\",\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "10. Create Work Order",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Work order created successfully\", function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "if (pm.response.code === 201) {",
              "    var jsonData = pm.response.json();",
              "    pm.collectionVariables.set(\"work_order_id\", jsonData.id);",
              "    console.log(\"✅ Work Order ID: \" + jsonData.id);",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{technician_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"claimId\": {{claim_id}},\n  \"technicianId\": {{technician_id}},\n  \"estimatedLaborHours\": 2.5,\n  \"startTime\": \"2024-01-20T08:00:00\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/work-orders/create",
          "host": ["{{base_url}}"],
          "path": ["api", "work-orders", "create"]
        }
      }
    },
    {
      "name": "11. Reserve Parts for Work Order",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Parts reserved successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Reserved parts list present\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.be.an('array');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{technician_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"workOrderId\": {{work_order_id}},\n  \"items\": [\n    {\n      \"partId\": 6,\n      \"quantity\": 1\n    }\n  ]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/inventory/reserve",
          "host": ["{{base_url}}"],
          "path": ["api", "inventory", "reserve"]
        }
      }
    },
    {
      "name": "12. Update Work Order Progress",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Work order updated successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Work order details updated\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.result).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{technician_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"result\": \"Battery temperature sensor replaced successfully. All systems tested and functioning normally.\",\n  \"laborHours\": 2.5,\n  \"partsUsed\": [\n    {\n      \"partId\": 6,\n      \"partName\": \"Battery Temperature Sensor\",\n      \"quantity\": 1,\n      \"serialNumber\": \"SENS001-2024-001\"\n    }\n  ],\n  \"notes\": \"Sensor replacement completed. Battery pack #2 temperature readings now normal.\",\n  \"images\": [\n    \"/uploads/repairs/sensor_installed.jpg\",\n    \"/uploads/repairs/calibration_complete.jpg\"\n  ]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/work-orders/{{work_order_id}}/update",
          "host": ["{{base_url}}"],
          "path": ["api", "work-orders", "{{work_order_id}}", "update"]
        }
      }
    },
    {
      "name": "13. Complete Work Order",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Work order completed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Work order marked as completed\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.endTime).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{technician_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{}"
        },
        "url": {
          "raw": "{{base_url}}/api/work-orders/{{work_order_id}}/complete",
          "host": ["{{base_url}}"],
          "path": ["api", "work-orders", "{{work_order_id}}", "complete"]
        }
      }
    },
    {
      "name": "14. Complete Repair",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Repair completed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status updated to REPAIR_COMPLETED\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.include(\"REPAIR_COMPLETED\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{technician_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"repairSummary\": \"Battery temperature sensor replaced. All systems tested and functioning normally.\",\n  \"partsReplaced\": [\n    {\n      \"partId\": 6,\n      \"partName\": \"Battery Temperature Sensor\",\n      \"quantity\": 1,\n      \"serialNumber\": \"SENS001-2024-001\"\n    }\n  ],\n  \"laborHours\": 2.5,\n  \"finalCost\": 250.00,\n  \"qualityCheckPassed\": true,\n  \"testResults\": \"All temperature sensors reading normal. Battery pack functioning correctly.\",\n  \"images\": [\n    \"/uploads/repairs/final_test_results.jpg\"\n  ]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{claim_id}}/complete-repair",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{claim_id}}", "complete-repair"]
        }
      }
    },
    {
      "name": "15. Perform Final Inspection",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Final inspection completed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status updated to READY_FOR_HANDOVER\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.include(\"READY_FOR_HANDOVER\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{technician_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"inspectionResults\": \"All systems functioning correctly. Temperature sensors calibrated. Vehicle ready for customer pickup.\",\n  \"qualityChecks\": [\n    \"Battery temperature monitoring - PASS\",\n    \"Charging system - PASS\",\n    \"Motor operation - PASS\",\n    \"Safety systems - PASS\"\n  ],\n  \"inspectorName\": \"Bob Wilson\",\n  \"inspectionDate\": \"2024-01-20T15:30:00\",\n  \"notes\": \"Repair completed successfully. All quality checks passed.\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{claim_id}}/final-inspection",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{claim_id}}", "final-inspection"]
        }
      }
    },
    {
      "name": "16. Handover Vehicle to Customer",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Vehicle handover completed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status updated to COMPLETED\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.include(\"COMPLETED\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"handoverDate\": \"2024-01-20T16:00:00\",\n  \"customerSatisfaction\": \"Satisfied\",\n  \"customerSignature\": \"Michael Thompson\",\n  \"mileageAtHandover\": 25000,\n  \"notes\": \"Customer informed about repair details. Warranty documentation provided.\",\n  \"documentsProvided\": [\n    \"Warranty repair certificate\",\n    \"Service history update\",\n    \"Quality inspection report\"\n  ]\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{claim_id}}/handover",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{claim_id}}", "handover"]
        }
      }
    },
    {
      "name": "17. Close Claim",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Claim closed successfully\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Claim status updated to CLOSED\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.include(\"CLOSED\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{sc_staff_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"closureReason\": \"Repair completed successfully and vehicle handed over to customer\",\n  \"finalNotes\": \"Battery temperature sensor replacement completed. Customer satisfied with service.\",\n  \"totalCost\": 250.00,\n  \"warrantyCoverage\": \"Full warranty coverage applied\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/claims/{{claim_id}}/close",
          "host": ["{{base_url}}"],
          "path": ["api", "claims", "{{claim_id}}", "close"]
        }
      }
    }
  ]
}
